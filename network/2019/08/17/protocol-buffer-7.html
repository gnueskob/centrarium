<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143826254-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-143826254-1');
  </script>
  

  <title>Google protocol buffer (7) with C++</title>
  <meta name="description" content="이번 포스팅에서는 protobuf를 사용한 예제를 살펴본다.">
  
  <meta name="author" content="Gnues">
  <meta name="copyright" content="&copy; Gnues 2019">
  

  <!-- External libraries -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/styles/vs2015.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/css/lightbox.css">

  <!-- Favicon and other icons (made with http://www.favicon-generator.org/) -->
  <link rel="shortcut icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
  <link rel="manifest" href="/assets/icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  
  <!-- Facebook OGP cards -->
  <meta property="og:description" content="이번 포스팅에서는 protobuf를 사용한 예제를 살펴본다." />
  <meta property="og:url" content="http://gnueskob.github.io" />
  <meta property="og:site_name" content="Don't be Expert Beginner" />
  <meta property="og:title" content="Google protocol buffer (7) with C++" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="http://gnueskob.github.io/assets/logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="612" />
  <meta property="og:image:height" content="605" />
  

  
  <!-- Twitter: card tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Google protocol buffer (7) with C++">
  <meta name="twitter:description" content="이번 포스팅에서는 protobuf를 사용한 예제를 살펴본다.">
  <meta name="twitter:image" content="http://gnueskob.github.io/assets/logo.png">
  <meta name="twitter:url" content="http://gnueskob.github.io">
  

  

  <!-- Site styles -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://gnueskob.github.io/network/2019/08/17/protocol-buffer-7.html">
  <link rel="alternate" type="application/rss+xml" title="Don't be Expert Beginner" href="http://gnueskob.github.io/feed.xml" />
</head>


  <body>

    <header class="navigation" role="banner">
  <div class="navigation-wrapper">
    <a href="/" class="logo">
      
      <img src="/assets/logo.png" alt="Don't be Expert Beginner">
      
    </a>
    <a href="javascript:void(0)" class="navigation-menu-button" id="js-mobile-menu">
      <i class="fa fa-bars"></i>
    </a>
    <nav role="navigation">
      <ul id="js-navigation-menu" class="navigation-menu show">
        
          
          <li class="nav-link"><a href="/about/">About Me</a>
          
        
          
        
          
        
          
        
          
          <li class="nav-link"><a href="/posts/">Posts</a>
          
        
          
          <li class="nav-link"><a href="/timeline/">Timeline</a>
          
        
          
          <li class="nav-link"><a href="/typography/">Typography</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </nav>
  </div>
</header>


    <div class="page-content">
        <div class="post">

<div class="post-header-container " >
  <div class="scrim ">
    <header class="post-header">
      <h1 class="title">Google protocol buffer (7) with C++</h1>
      <p class="info">by <strong>Gnues</strong></p>
    </header>
  </div>
</div>

<div class="wrapper">

 <span class="page-divider">
  <span class="one"></span>
  <span class="two"></span>
</span>
 

<section class="post-meta">
  <div class="post-date">2019. 8. 17. 22:03</div>
  <div class="post-categories">
  in 
    
    <a href="/category/network">Network</a>
    
  
  </div>
</section>

<article class="post-content">
  <p>이번 포스팅에서는 protobuf를 사용한 예제를 살펴본다.</p>

<hr />

<h2 id="network-packet-buffer">Network Packet buffer</h2>

<p>이번에 소개할 예제에서는 프로토콜 버퍼를 네트워크 라이브러리에서 사용하는 예제이다.</p>

<p>네트워크상 주고받는 패킷들이 완전한 상태로 오지 않는 경우가 있기 때문에 이를 저장해두는 공간이 필요하다.</p>

<p>때문에 이를 저장해두고 완전한 패킷 사이즈만큼 데이터를 받으면 처리하게 된다.</p>

<p>예제의 네트워크 라이브러리에서는 byte 배열의 패킷 버퍼에 프로토콜 버퍼를 이용해서 직렬화(Serialize)하여 쓰고 읽는다.</p>

<hr />

<h2 id="proto-message">예제 .proto message</h2>

<p>간단히 로그인, 로그아웃이 가능한 서버가 있다고 가정하자.</p>

<p>아래 proto message는 login, logout 기능별 요청, 응답 패킷에 대응되는 message이다.</p>

<p>echo는 그대로 돌려주기 때문에 하나의 message로만 사용할 것이다.</p>

<div class="language-proto highlighter-rouge"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>
<span class="kn">package</span> <span class="nn">lsbProto</span><span class="p">;</span>

<span class="c1">// Echo packet
// Request and Response format are same
</span><span class="kd">message</span> <span class="nc">Echo</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">msg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************/</span>

<span class="c1">// Login Packet
</span><span class="kd">message</span> <span class="nc">LoginReq</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">pw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">LoginRes</span> <span class="p">{</span>
  <span class="kt">int32</span> <span class="na">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************/</span>

<span class="c1">// Logout Packet
</span><span class="kd">message</span> <span class="nc">LogoutReq</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">LogoutRes</span> <span class="p">{</span>
  <span class="kt">int32</span> <span class="na">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************/</span>
</code></pre>
</div>

<p>이 <strong>.proto</strong> 파일을 protoc로 컴파일하여 생성된 클래스를 프로젝트에 포함시켜 사용한다.</p>

<p>아래 설명의 proto 클래스란 .proto 파일의 메시지를 컴파일하여 생성된 클래스를 의미한다.</p>

<hr />

<h2 id="message-class">Message class</h2>

<p>예제 코드를 소개하기에 앞서 프로토콜 버퍼에 존재하는 <strong>Message</strong> 클래스를 소개한다.</p>

<p><strong>.proto</strong>파일을 통해 생성된 클래스는 모두 <strong>::PROTOBUF_NAMESPACE_ID::Message</strong> 클래스를 상속한다.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="c1">// .proto 파일로 생성한 'message Echo'의 클래스 예시
</span><span class="k">class</span> <span class="nc">Echo</span> <span class="o">:</span>
    <span class="k">public</span> <span class="o">::</span><span class="n">PROTOBUF_NAMESPACE_ID</span><span class="o">::</span><span class="n">Message</span> <span class="cm">/* @@protoc_insertion_point(class_definition:lsbProto.Echo) */</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">Echo</span><span class="p">();</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">Echo</span><span class="p">();</span>

  <span class="p">...</span>
</code></pre>
</div>

<p><strong>.proto</strong> 파일에서 여러가지 메시지를 정의하고 각 메시지마다 클래스를 생성시키지만, 모두 <strong>Message</strong>로 캐스팅하여 처리할 수 있다.</p>

<hr />

<h2 id="section">예제 서버의 패킷 처리</h2>

<p>클라이언트로부터 패킷이 들어왔다고할 때 서버에서는 다음과 같은 순서를 거쳐 패킷을 처리한다.</p>

<ol>
  <li>서버로 패킷이 전달되고 패킷버퍼에 패킷이 저장된다.</li>
  <li>패킷 헤더에 정의된 패킷 body크기 만큼 충분한 양의 패킷이 들어왔다면 한 단위의 요청이 들어왔다고 판단한다.</li>
  <li>요청 패킷에 대한 처리를 하기위해 패킷 버퍼(byte배열)에서 패킷 body크기만큼 데이터를 가져온다.</li>
  <li>패킷을 처리한다.</li>
  <li>처리 완료후 결과를 다시 반대의 순서로 응답 패킷을 만들어 클라이언트에게 보낸다.</li>
</ol>

<p>흔히 처리되는 클라-서버 간의 네트워크 프로세스이다.</p>

<p>우리가 지금 주목해야 할 부분은 <strong>(3)</strong>번째 단계의 패킷버퍼의 데이터 역직렬화 부분과 <strong>(5)</strong>번째의 직렬화 부분이다.</p>

<hr />

<h2 id="proto-class">Proto class</h2>

<p><strong>C++</strong>로 만들어진 네트워크 라이브러리 코드는 다음과 같다.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="k">using</span> <span class="k">namespace</span> <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="p">;</span>

<span class="p">...</span>

<span class="n">ERROR_CODE</span> <span class="n">PacketProcess</span><span class="o">::</span><span class="n">Login</span><span class="p">(</span><span class="n">PacketInfo</span> <span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">lsbProto</span><span class="o">::</span><span class="n">LoginReq</span> <span class="n">reqPkt</span><span class="p">;</span>
   <span class="k">auto</span> <span class="n">pReqProto</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reqPkt</span><span class="p">);</span>
   <span class="n">ParseDataToProto</span><span class="p">(</span><span class="n">pReqProto</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">pData</span><span class="p">,</span> <span class="n">packet</span><span class="p">.</span><span class="n">PacketBodySize</span><span class="p">);</span>

   <span class="k">auto</span> <span class="n">err</span> <span class="o">=</span> <span class="n">m_pUserMngr</span><span class="o">-&gt;</span><span class="n">AddUser</span><span class="p">(</span><span class="n">packet</span><span class="p">.</span><span class="n">SessionId</span><span class="p">,</span> <span class="n">reqPkt</span><span class="p">.</span><span class="n">id</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>

   <span class="n">lsbProto</span><span class="o">::</span><span class="n">LoginRes</span> <span class="n">resPkt</span><span class="p">;</span>
   <span class="n">resPkt</span><span class="p">.</span><span class="n">set_res</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">int32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">err</span><span class="p">));</span>

   <span class="k">auto</span> <span class="n">packetId</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PACKET_ID</span><span class="o">::</span><span class="n">LOGIN_RES</span><span class="p">);</span>
   <span class="k">auto</span> <span class="n">pResProto</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resPkt</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">ERROR_CODE</span><span class="o">::</span><span class="n">NONE</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="n">m_pLogicMain</span><span class="o">-&gt;</span><span class="n">SendProto</span><span class="p">(</span><span class="n">packet</span><span class="p">.</span><span class="n">SessionId</span><span class="p">,</span> <span class="n">packetId</span><span class="p">,</span> <span class="n">pResProto</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">m_pConnectedUserManager</span><span class="o">-&gt;</span><span class="n">SetLogin</span><span class="p">(</span><span class="n">packet</span><span class="p">.</span><span class="n">SessionId</span><span class="p">);</span>

   <span class="n">m_Log</span><span class="o">-&gt;</span><span class="n">Write</span><span class="p">(</span><span class="n">LV</span><span class="o">::</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s">"%s | Login. id : %s, session Id : %d"</span><span class="p">,</span> <span class="n">__FUNCTION__</span><span class="p">,</span> <span class="n">reqPkt</span><span class="p">.</span><span class="n">id</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">packet</span><span class="p">.</span><span class="n">SessionId</span><span class="p">);</span>
   <span class="n">m_pLogicMain</span><span class="o">-&gt;</span><span class="n">SendProto</span><span class="p">(</span><span class="n">packet</span><span class="p">.</span><span class="n">SessionId</span><span class="p">,</span> <span class="n">packetId</span><span class="p">,</span> <span class="n">pResProto</span><span class="p">);</span>

   <span class="k">return</span> <span class="n">ERROR_CODE</span><span class="o">::</span><span class="n">NONE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>위 코드는 로그인 과정의 예제 코드이다.</p>

<p>.proto 파일의 <code class="highlighter-rouge">package lsbProto;</code> 문구로 namespace가 <code class="highlighter-rouge">lsbProto</code>임을 확인할 수 있다.</p>

<p><code class="highlighter-rouge">PacketProcess::Login</code> 함수에서 벌어지는 일은 다음과 같다.</p>

<ol>
  <li>
    <p>로그인 요청 패킷 정보를 담을 <code class="highlighter-rouge">lsbProto::LoginReq</code> reqPkt 인스턴스를 선언</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">ParseDataToProto</code> 함수에서는 <code class="highlighter-rouge">Message</code>와 패킷 포인터, 데이터 크기를 받아 파싱</p>
  </li>
  <li>proto(<code class="highlighter-rouge">LoginReq</code>) 클래스를 통해 서버 로직을 처리
    <ul>
      <li><code class="highlighter-rouge">LoginReq</code>의 ID string 사용</li>
      <li><code class="highlighter-rouge">reqPkt.id().c_str()</code></li>
    </ul>
  </li>
  <li>응답 패킷을 보내기 위한 <code class="highlighter-rouge">lsbProto::LoginRes</code> resPkt 인스턴스 선언
    <ul>
      <li><code class="highlighter-rouge">LoginRes</code>의 응답 코드를 세팅</li>
      <li><code class="highlighter-rouge">LoginRes.set_res(...)</code></li>
    </ul>
  </li>
  <li>
    <p>로그인 응답 코드 셋팅 <code class="highlighter-rouge">resPkt.set_res(...)</code></p>
  </li>
  <li>요청 데이터와 마찬가지로 응답 패킷 클래스(<code class="highlighter-rouge">LoginRes</code>)를 <code class="highlighter-rouge">Message</code>로 캐스팅하여 메시지 전송(<code class="highlighter-rouge">SendProto</code>)</li>
</ol>

<p>사전에 정의한 Proto 클래스의 멤버 변수를 사용하기 위해서는 (3), (4) 항목처럼 사용하면 된다.</p>

<p>.proto파일에서 정의한 <code class="highlighter-rouge">LoginReq</code>의 message에서 정의한 <code class="highlighter-rouge">id</code>, <code class="highlighter-rouge">pw</code>는 같은 이름의 함수로 얻을 수 있으며 해당 값을 바꾸기 위해선 <code class="highlighter-rouge">set_</code> prefix를 붙인 함수를 이용한다.</p>

<hr />

<h2 id="read-from-char-array-to-proto-class">Read from char array to proto class</h2>

<p>예제의 네트워크 라이브러리에서는 byte배열(<code class="highlighter-rouge">char</code> array)로 패킷 버퍼를 구현하였다.</p>

<p><code class="highlighter-rouge">google::protobuf::io::ArrayInputStream</code>를 통해 <code class="highlighter-rouge">char</code>배열로부터 자신이 정의한 Proto 클래스로 역직렬화(Unserialize) 할 수 있다.</p>

<p>위의 예제에서 사용한 <code class="highlighter-rouge">PacketProcess::ParseDataToProto(..)</code>함수를 자세히 들여다보자.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="kt">bool</span> <span class="n">PacketProcess</span><span class="o">::</span><span class="n">ParseDataToProto</span><span class="p">(</span><span class="n">Message</span><span class="o">*</span> <span class="n">pProto</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pData</span><span class="p">,</span> <span class="kt">short</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">io</span><span class="o">::</span><span class="n">ArrayInputStream</span> <span class="n">is</span><span class="p">(</span><span class="n">pData</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">pProto</span><span class="o">-&gt;</span><span class="n">ParseFromZeroCopyStream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<ul>
  <li>함수는 3가지를 parameter로 전달받는다.
    <ul>
      <li>정의한 proto 클래스(<code class="highlighter-rouge">LoginReq</code>)의 주소를 <code class="highlighter-rouge">Message*</code>로 캐스팅한 포인터</li>
      <li>읽어들일 데이터가 있는 패킷 버퍼의 위치(포인터)</li>
      <li>해당 패킷 버퍼의 위치로부터 읽어들일 데이터의 크기 (bytes 수)</li>
    </ul>
  </li>
  <li>
    <p><code class="highlighter-rouge">google::protobuf::io::ArrayInputStream</code>를 이용해서 byte 배열로부터 <code class="highlighter-rouge">Message</code>로 데이터 파싱이 가능하다.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">ArrayInputStream</code> 인스턴스에 데이터 위치(<code class="highlighter-rouge">pointer</code>)와 읽어올 데이터의 크기를 알려준다.</p>
  </li>
  <li><code class="highlighter-rouge">Message</code>의 <code class="highlighter-rouge">ParseFromZeroCopyStream(..)</code> 멤버함수를 통해 패킷 버퍼데이터를 proto(<code class="highlighter-rouge">LoginReq</code>) 클래스로 파싱한다.</li>
</ul>

<p><code class="highlighter-rouge">Message</code> 클래스로 업캐스팅하여 사용하지만 패킷 버퍼에 존재하던 데이터를 정의한 클래스의 형태로 파싱할 수 있다.</p>

<hr />

<h2 id="write-from-char-array-to-proto-class">Write from char array to proto class</h2>

<p>응답을 위한 Proto 클래스에 원하는 값을 셋팅했다면 데이터를 직렬화하여 패킷 버퍼에 저장해야한다.</p>

<p>이때 사용하는 <code class="highlighter-rouge">SendProto(..)</code> 함수를 자세히 들여다보자.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="n">LogicMain</span><span class="o">::</span><span class="n">SendProto</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">sessionId</span><span class="p">,</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">packetId</span><span class="p">,</span> <span class="n">Message</span><span class="o">*</span> <span class="n">pMsg</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">auto</span> <span class="n">bodyLength</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">ByteSize</span><span class="p">());</span>
  <span class="k">auto</span> <span class="n">totalSize</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">short</span><span class="o">&gt;</span><span class="p">(</span><span class="n">PACKET_HEADER_SIZE</span> <span class="o">+</span> <span class="n">bodyLength</span><span class="p">);</span>
  <span class="n">PacketHeader</span> <span class="n">header</span><span class="p">{</span> <span class="n">totalSize</span><span class="p">,</span> <span class="n">packetId</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">};</span>

  <span class="k">auto</span> <span class="n">err</span> <span class="o">=</span> <span class="n">m_pNetwork</span><span class="o">-&gt;</span><span class="n">SendPacket</span><span class="p">(</span>
    <span class="n">sessionId</span>
    <span class="p">,</span> <span class="n">bodyLength</span>
    <span class="p">,</span> <span class="nb">nullptr</span>
    <span class="p">,</span> <span class="n">PACKET_HEADER_SIZE</span>
    <span class="p">,</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">)</span>
    <span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">pMsg</span><span class="p">](</span><span class="kt">char</span><span class="o">*</span> <span class="n">writePos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bodyLength</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
      <span class="n">io</span><span class="o">::</span><span class="n">ArrayOutputStream</span> <span class="n">os</span><span class="p">(</span><span class="n">writePos</span><span class="p">,</span> <span class="n">bodyLength</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">SerializeToZeroCopyStream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os</span><span class="p">);</span>
    <span class="p">});</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">NET_ERROR_CODE</span><span class="o">::</span><span class="n">NONE</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<ul>
  <li>
    <p>세션 ID, 패킷 ID, Proto 클래스 포인터를 <code class="highlighter-rouge">Message*</code>로 업캐스팅한 3가지 인자를 받는다.</p>
  </li>
  <li>패킷을 보내기 위해 패킷 헤더를 생성한다.
    <ul>
      <li>패킷 body의 크기를 알기 위해 proto 클래스의 크기를 확인한다. <code class="highlighter-rouge">pMsg-&gt;ByteSize()</code></li>
      <li>미리 정의한 패킷 헤더의 크기와 합쳐 총 패킷의 크기를 계산한다.</li>
      <li>패킷 ID를 추가하여 패킷 헤더를 만든다.</li>
      <li>
        <p>예제에서 사용된 패킷 헤더 구조는 다음과 같다.</p>

        <div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="k">struct</span> <span class="n">PacketHeader</span>
<span class="p">{</span>
  <span class="kt">short</span> <span class="n">PacketSize</span><span class="p">;</span>
  <span class="kt">short</span> <span class="n">Id</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Reserved</span><span class="p">;</span>
<span class="p">};</span>
</code></pre>
        </div>
      </li>
    </ul>
  </li>
  <li>예제의 네트워크 라이브러리에서는 <code class="highlighter-rouge">SendPacket(..)</code>함수를 제공하여 패킷을 보낼 수 있다.
    <ul>
      <li>일반적으로 보내려는 데이터의 위치(<code class="highlighter-rouge">char *</code> 포인터)와 크기를 보내면 라이브러리 상에서 자동으로 패킷 버퍼에 데이터를 복사한다.</li>
      <li>하지만 사용자가 직접 패킷 버퍼에 데이터를 복사하는 함수를 넘겨주면 해당 함수를 통해 패킷 버퍼에 데이터를 복사한다.</li>
    </ul>
  </li>
</ul>

<p>Protobuf를 사용하기 때문에 패킷버퍼에 데이터를 복사하는 별도의 함수를 넘겨줘야 하고 그 부분이 <code class="highlighter-rouge">SendPacket(..)</code> 함수에 인자로 추가된 람다함수이다.</p>

<div class="language-cpp highlighter-rouge"><pre class="highlight"><code><span class="p">[</span><span class="o">&amp;</span><span class="n">pMsg</span><span class="p">](</span><span class="kt">char</span><span class="o">*</span> <span class="n">writePos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bodyLength</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
<span class="p">{</span>
  <span class="n">io</span><span class="o">::</span><span class="n">ArrayOutputStream</span> <span class="n">os</span><span class="p">(</span><span class="n">writePos</span><span class="p">,</span> <span class="n">bodyLength</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">pMsg</span><span class="o">-&gt;</span><span class="n">SerializeToZeroCopyStream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">os</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>이 람다함수는 proto 클래스 포인터를 캡쳐하고 두 개의 변수를 인자로 받는다.</p>

<p><code class="highlighter-rouge">char* writePos</code>는 패킷 버퍼가 가리키는 쓰기가능한 버퍼의 시작점이고 <code class="highlighter-rouge">int bodyLength</code>는 보내야할 데이터의 크기이다.</p>

<p>네트워크 라이브러리 제공하는 2개의 변수를 통해 패킷 버퍼에 데이터를 복사하는 함수를 만들 수 있다.</p>

<p>Byte 배열 역직렬화는 <code class="highlighter-rouge">google::protobuf::io::ArrayOutputStream</code>을 통해 할 수 있고 이 때 데이터를 저장하려는 byte 배열의 포인터와 크기가 필요하다.</p>

<ul>
  <li>
    <p>앞서 네트워크 라이브러리가 제공하는 두 개의 인자를 통해 <code class="highlighter-rouge">ArrayOutputStream</code>인스턴스를 만든다.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">Message</code>의 <code class="highlighter-rouge">SerializeToZeroCopyStream(..)</code> 멤버함수를 통해 proto 클래스의 데이터를 byte 배열에 직렬화한다.</p>
  </li>
</ul>

<p>이로써 응답 패킷 proto 클래스의 데이터를 직렬화하여 패킷 버퍼로 저장하게 된다.</p>

</article>



<section class="tags">
  <strong>Tags:</strong> <a href="/tag/network">network</a>,&nbsp;<a href="/tag/protocol-buffer">protocol-buffer</a>,&nbsp;<a href="/tag/google">google</a>,&nbsp;<a href="/tag/cpp">cpp</a>
</section>



<section class="rss">
  <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
</section>

<section class="share">
  <span>Share: </span>
  
    
    
      <a href="//twitter.com/share?text=Google+protocol+buffer+%287%29+with+C%2B%2B&url=http%3A%2F%2Fgnueskob.github.io%2Fnetwork%2F2019%2F08%2F17%2Fprotocol-buffer-7.html&via="
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
        <i class="fa fa-twitter-square fa-lg"></i>
      </a>
    
    
    
    
    
    
    
  
    
    
    
      <a href="//www.facebook.com/sharer.php?t=Google+protocol+buffer+%287%29+with+C%2B%2B&u=http%3A%2F%2Fgnueskob.github.io%2Fnetwork%2F2019%2F08%2F17%2Fprotocol-buffer-7.html"
        onclick="window.open(this.href, 'facebook-share', 'width=550,height=255');return false;">
        <i class="fa fa-facebook-square fa-lg"></i>
      </a>
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
      <a href="//www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Fgnueskob.github.io%2Fnetwork%2F2019%2F08%2F17%2Fprotocol-buffer-7.html"
        onclick="window.open(this.href, 'linkedin-share', 'width=550,height=255');return false;">
        <i class="fa fa-linkedin-square fa-lg"></i>
      </a>
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
    
  
    
    
    
    
    
    
    
      <a href="//www.reddit.com/submit" onclick="window.location = '//www.reddit.com/submit?url=' + encodeURIComponent('http://gnueskob.github.io/network/2019/08/17/protocol-buffer-7.html') + '&title=Google protocol buffer (7) with C++'; return false">
        <i class="fa fa-reddit-square fa-lg"></i>
      </a>
    
    
  
    
    
    
    
    
    
    
    
  
</section>




<section class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'https-gnueskob-github-io';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



</div>
</div>

    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h3 class="footer-heading">Don't be Expert Beginner</h3>

    <div class="site-navigation">

      <p><strong>Site Map</strong></p>
      <ul class="pages">
        
        
          <li class="nav-link"><a href="/about/">About Me</a>
        
        
        
        
        
        
        
        
        
          <li class="nav-link"><a href="/posts/">Posts</a>
        
        
        
          <li class="nav-link"><a href="/timeline/">Timeline</a>
        
        
        
          <li class="nav-link"><a href="/typography/">Typography</a>
        
        
        
        
        
        
        
        
        
        
        
        
        
        
      </ul>
    </div>

    <div class="site-contact">

      <p><strong>Contact</strong></p>
      <ul class="social-media-list">
        <li>
          <a href="mailto:gnueskob@gmail.com">
            <i class="fa fa-envelope-o"></i>
            <span class="username">gnueskob@gmail.com</span>
          </a>
        </li>

        
          
        
          
        
          
          <li>
            <a href="https://github.com/gnueskob" title="Fork me on GitHub">
              <i class="fa fa-github"></i>
              <span class="username">gnues</span>
            </a>
          </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        

      </ul>
    </div>

    <div class="site-signature">
      <p class="rss-subscribe text"><strong>Subscribe <a href="/feed.xml">via RSS</a></strong></p>
      <p class="text">This blog is designed to share server programming information.
</p>
    </div>

  </div>

</footer>

<!-- Scripts -->
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.8/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightbox2/2.7.1/js/lightbox.min.js"></script>

<script type="text/javascript">
$(document).ready(function() {
  // Default syntax highlighting
  hljs.initHighlightingOnLoad();

  // Header
  var menuToggle = $('#js-mobile-menu').unbind();
  $('#js-navigation-menu').removeClass("show");
  menuToggle.on('click', function(e) {
    e.preventDefault();
    $('#js-navigation-menu').slideToggle(function(){
      if($('#js-navigation-menu').is(':hidden')) {
        $('#js-navigation-menu').removeAttr('style');
      }
    });
  });
});

</script>



  </body>

</html>
